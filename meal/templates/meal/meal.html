{% extends "base.html" %}
{% load static %}
<!-- 데이트피커 -->
<link rel="stylesheet" href="http://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

<!-- 차트 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{% block content %}

<div class="container my-3">
    <div class="row justify-content-end">
        <form method="post">
            {% if date %}
            <input type="hidden" name="kid_id" value="{{ kid_id }}">
            <input type="text" name="datepicker" id="datepicker" value="{{ date }}">
            <button class="btn main_btn" id ="date">선택</button>
            {% else %}
            <input type="text" name="datepicker" id="datepicker">
            <button class="btn main_btn" id ="date">선택</button>
            {% endif %}
        </form>
    </div>
    <div class="row mt-3 mb-3 ml-2 kid_pofile">
        <div class="col mt-4 ml-4">
            <img class="img" id="profile" src="{{ kid.img.url }}"/>  
        </div>
        <div class="col mt-5 ml-5">
            <div class="row"><h5>이름 : {{kid.name}}</h5></div>
            <div class="row"><h5>생일 : {{kid.birthday | date:"y-m-d" }}</h5></div>
            <div class="row"><h5>키 : {{kid.height}} cm</h5></div>
            <div class="row"><h5>몸무게 : {{kid.weight}} kg</h5></div>
            <div class="row">
                <a class="btn main_btn" href="/user/update/kid_info/each/">아이 프로필 수정</a>
            </div>
        </div>
        <div class="col mt-1 mr-3">
            <div class="chart-container">
                <canvas id="myChart">
                    <p>Hello Fallback World</p>
                </canvas> 
            </div>
        </div>
    </div>
    <div class="row mt-5 mb-2 description">
        <div class="col ml-3 d-flex justify-content-center"><h5><b>식단 사진</b></h5></div>
        <div class="col ml-3 d-flex justify-content-center"><h5><b>우리 아이 식단</b></h5></div>
        <div class="col ml-3 d-flex justify-content-center"><h5><b>식단 결과</b></h5></div>
    </div>
    <!-- 아침 -->
    <div class="row" id="morning_row">
        <div class="col ml-3 frame">
            {% if morning_meal.0.img %}
            <div class="row d-flex justify-content-center mt-3 mb-3">
                <img class="img" id="morning" src="{{ morning_meal.0.img.url }}"/>
            </div>
            {% else %}
            <div class="row d-flex justify-content-center mt-3 mb-3">
                <img class="img" id="morning" src="{% static 'image/식판.png' %}" alt="이미지가 존재하지 않습니다."/>
            </div>
            {% endif %}
            {% if morning_meal %}
            <div class="row d-flex justify-content-center mb-3">
                <button class="btn sub_btn morning_upload mr-1" disabled>아침 식단 업로드</button>
                <button class="btn main_btn morning_del_btn">삭제</button>
            </div>
            {% else %}
            <div class="row d-flex justify-content-center mb-3">
                <button class="btn sub_btn morning_upload mr-1">아침 식단 업로드</button>
                <button class="btn main_btn morning_del_btn" disabled>삭제</button>
            </div>
            {% endif %}
        </div>
        <div class="col ml-3 mb-3 frame" id="morning_frame" style="overflow-y: auto;">
            <div class="row mt-3 d-flex justify-content-center"></div>
            <div class="row d-flex justify-content-center mt-3 p-2" id="morning_food_form">
                {% if morning_meal %}
                    {% for diet in morning_diet %}
                    <div class="row ml-1 mr-1 mt-3 mb-3">
                        <input class="col w-100 mr-1" value="{{ diet.nutrition.food }}" name="food" disabled/>
                        <select name="portions" disabled>
                            <option value="{{ diet.portions }}인분">{{ diet.portions }}인분</option>
                        </select>
                        <button class="btn main_btn ml-1 del_food_btn" id="del_morning{{ diet.nutrition.food }}_btn" disabled>삭제</button>
                    </div>
                    {% endfor %}
                    <button class="btn sub_btn mt-1 w-75 add_food" disabled>식단 추가</button>
                {% else %}
                <button class="btn sub_btn mt-5 w-75 add_food">식단 추가</button>
                {% endif %}
            </div>
            <div class="row d-flex justify-content-center mt-2 p-2 meal_submit">
                {% if morning_diet %}
                <button class="btn main_btn w-75 result_btn" disabled>결과 확인</button>
                {% else %}
                <button class="btn main_btn w-75 result_btn">결과 확인</button>
                {% endif %}
            </div>
        </div>
        <div class="col ml-3 mb-3 frame" style="overflow-y: auto;">
        {% if morning_diet %}
            {% if good_kcal_breakfast != 0 %}
            <div class="row mt-5 justify-content-center text-center">
                섭취&nbsp;<font color="blue"><b>{{ good_kcal_breakfast }}</b></font><font color="gray">&nbsp;kcal</font>&nbsp;(충분)
            </div>
            <div class="row justify-content-center text-center"><small>권장 일일&nbsp;<b>2000</b><font color="gray">&nbsp;kcal</font></small></div>
            {% elif bad_kcal_breakfast != 0 %}
            <div class="row mt-5 justify-content-center text-center">
                섭취&nbsp;<font color="red"><b>{{ bad_kcal_breakfast }}</b></font><font color="gray">&nbsp;kcal</font>&nbsp;(부족/과잉)
            </div>
            <div class="row justify-content-center text-center"><small>권장 일일&nbsp;<b>2000</b><font color="gray">&nbsp;kcal</font></small></div>
            {% endif %}
            {% if good_food_breakfast %}
            <div class="row mt-2 mb-1 justify-content-center">
                <div class="col d-flex justify-content-center">
                    <img class="w-25" src="{% static 'image/잘한 식단 아이.png' %}" alt="로고 이미지"/>
                </div>
            </div>
                {% for food in good_food_breakfast %}
                <div class="row justify-content-center text-center">{{ food }}</div>
                {% endfor %}
            {% else %}
                <div class="row mt-2 justify-content-center">
                    <div class="col d-flex justify-content-center">
                        <img class="w-25" src="{% static 'image/못한 식단 아이.png' %}" alt="로고 이미지"/>
                    </div>
                </div>
                <div class="row mt-2 mb-2 justify-content-center text-center">아쉬운 식단이네요</div>
            {% endif %}    
            {% if bad_food_breakfast %}    
            <div class="row justify-content-center mt-1">
                <button class="btn sub_btn morning_nu_result_btn">부족/과잉 영양성분 보기</button>
            </div>
            {% else %}
            <div class="row justify-content-center mt-1">
                <button class="btn sub_btn" disabled>100점입니다!</button>
            </div>
            {% endif %}
        {% else %}
            <img class="w-100" src="{% static 'image/로고.png' %}" alt="로고 이미지"/>
        {% endif %}
        </div>
    </div>
    <!-- 점심 -->
    <div class="row" id="lunch_row">
        <div class="col ml-3 frame">
            {% if lunch_meal.0.img %}
            <div class="row d-flex justify-content-center mt-3 mb-3">
                <img class="img" id="lunch" src="{{ lunch_meal.0.img.url }}"/>
            </div>
            {% else %}
            <div class="row d-flex justify-content-center mt-3 mb-3">
                <img class="img" id="lunch" src="{% static 'image/식판.png' %}" alt="이미지가 존재하지 않습니다."/>
            </div>
            {% endif %}
            {% if lunch_meal %}
            <div class="row d-flex justify-content-center mb-3">
                <button class="btn sub_btn lunch_upload mr-1" disabled>점심 식단 업로드</button>
                <button class="btn main_btn lunch_del_btn">삭제</button>
            </div>
            {% else %}
            <div class="row d-flex justify-content-center mb-3">
                <button class="btn sub_btn lunch_upload mr-1">점심 식단 업로드</button>
                <button class="btn main_btn lunch_del_btn" disabled>삭제</button>
            </div>
            {% endif %}
        </div>
        <div class="col ml-3 mb-3 frame" id="lunch_frame" style="overflow-y: auto;">
            <div class="row mt-3 d-flex justify-content-center"></div>
            <div class="row d-flex justify-content-center mt-3 p-2" id="lunch_food_form">
                {% if lunch_meal %}
                    {% for diet in lunch_diet %}
                    <div class="row ml-1 mr-1 mt-3 mb-3">
                        <input class="col w-100 mr-1" value="{{ diet.nutrition.food }}" name="food" disabled/>
                        <select name="portions" disabled>
                            <option value="{{ diet.portions }}인분">{{ diet.portions }}인분</option>
                        </select>
                        <button class="btn main_btn ml-1 del_food_btn" id="del_morning{{ diet.nutrition.food }}_btn" disabled>삭제</button>
                    </div>
                    {% endfor %}
                    <button class="btn sub_btn mt-1 w-75 add_food" disabled>식단 추가</button>
                {% else %}
                <button class="btn sub_btn mt-5 w-75 add_food">식단 추가</button>
                {% endif %}
            </div>
            <div class="row d-flex justify-content-center mt-2 p-2 meal_submit">
                {% if lunch_diet %}
                <button class="btn main_btn w-75 result_btn" disabled>결과 확인</button>
                {% else %}
                <button class="btn main_btn w-75 result_btn">결과 확인</button>
                {% endif %}
            </div>
        </div>
        <div class="col ml-3 mb-3 frame" style="overflow-y: auto;">
        {% if lunch_diet %}
            {% if good_kcal_lunch != 0 %}
            <div class="row mt-5 justify-content-center text-center">
                섭취&nbsp;<font color="blue"><b>{{ good_kcal_lunch }}</b></font><font color="gray">&nbsp;kcal</font>&nbsp;(충분)
            </div>
            <div class="row justify-content-center text-center"><small>권장 일일&nbsp;<b>2000</b><font color="gray">&nbsp;kcal</font></small></div>
            {% elif bad_kcal_lunch != 0 %}
            <div class="row mt-5 justify-content-center text-center">
                섭취&nbsp;<font color="red"><b>{{ bad_kcal_lunch }}</b></font><font color="gray">&nbsp;kcal</font>&nbsp;(부족/과잉)
            </div>
            <div class="row justify-content-center text-center"><small>권장 일일&nbsp;<b>2000</b><font color="gray">&nbsp;kcal</font></small></div>
            {% endif %}
            {% if good_food_lunch %}
            <div class="row mt-2 mb-1 justify-content-center">
                <div class="col d-flex justify-content-center">
                    <img class="w-25" src="{% static 'image/잘한 식단 아이.png' %}" alt="로고 이미지"/>
                </div>
            </div>
                {% for food in good_food_lunch %}
                <div class="row justify-content-center text-center">{{ food }}</div>
                {% endfor %}
            {% else %}
                <div class="row mt-2 justify-content-center">
                    <div class="col d-flex justify-content-center">
                        <img class="w-25" src="{% static 'image/못한 식단 아이.png' %}" alt="로고 이미지"/>
                    </div>
                </div>
                <div class="row mt-2 mb-2 justify-content-center text-center">아쉬운 식단이네요</div>
            {% endif %}    
            {% if bad_food_lunch %}    
            <div class="row justify-content-center mt-1">
                <button class="btn sub_btn lunch_nu_result_btn">부족/과잉 영양성분 보기</button>
            </div>
            {% else %}
            <div class="row justify-content-center mt-1">
                <button class="btn sub_btn" disabled>100점입니다!</button>
            </div>
            {% endif %}
        {% else %}
            <img class="w-100" src="{% static 'image/로고.png' %}" alt="로고 이미지"/>
        {% endif %}
        </div>
    </div>        
    <!-- 저녁 -->
    <div class="row" id="evening_row">
        <div class="col ml-3 frame">
            {% if evening_meal.0.img %}
            <div class="row d-flex justify-content-center mt-3 mb-3">
                <img class="img" id="evening" src="{{ evening_meal.0.img.url }}"/>
            </div>
            {% else %}
            <div class="row d-flex justify-content-center mt-3 mb-3">
                <img class="img" id="evening" src="{% static 'image/식판.png' %}" alt="이미지가 존재하지 않습니다."/>
            </div>
            {% endif %}
            {% if evening_meal %}
            <div class="row d-flex justify-content-center mb-3">
                <button class="btn sub_btn evening_upload mr-1" disabled>저녁 식단 업로드</button>
                <button class="btn main_btn evening_del_btn">삭제</button>
            </div>
            {% else %}
            <div class="row d-flex justify-content-center mb-3">
                <button class="btn sub_btn evening_upload mr-1">저녁 식단 업로드</button>
                <button class="btn main_btn evening_del_btn" disabled>삭제</button>
            </div>
            {% endif %}
        </div>
        <div class="col ml-3 mb-3 frame" id="evening_frame" style="overflow-y: auto;">
            <div class="row mt-3 d-flex justify-content-center"></div>
            <div class="row d-flex justify-content-center mt-3 p-2" id="evening_food_form">
                {% if evening_meal %}
                    {% for diet in evening_diet %}
                    <div class="row ml-1 mr-1 mt-3 mb-3">
                        <input class="col w-100 mr-1" value="{{ diet.nutrition.food }}" name="food" disabled/>
                        <select name="portions" disabled>
                            <option value="{{ diet.portions }}인분">{{ diet.portions }}인분</option>
                        </select>
                        <button class="btn main_btn ml-1 del_food_btn" id="del_morning{{ diet.nutrition.food }}_btn" disabled>삭제</button>
                    </div>
                    {% endfor %}
                    <button class="btn sub_btn mt-1 w-75 add_food" disabled>식단 추가</button>
                {% else %}
                <button class="btn sub_btn mt-5 w-75 add_food">식단 추가</button>
                {% endif %}
            </div>
            <div class="row d-flex justify-content-center mt-2 p-2 meal_submit">
                {% if evening_diet %}
                <button class="btn main_btn w-75 result_btn" disabled>결과 확인</button>
                {% else %}
                <button class="btn main_btn w-75 result_btn">결과 확인</button>
                {% endif %}
            </div>
        </div>
        <div class="col ml-3 mb-3 frame" style="overflow-y: auto;">
        {% if evening_diet %}
            {% if good_kcal_dinner != 0 %}
            <div class="row mt-5 justify-content-center text-center">
                섭취&nbsp;<font color="blue"><b>{{ good_kcal_dinner }}</b></font><font color="gray">&nbsp;kcal</font>&nbsp;(충분)
            </div>
            <div class="row justify-content-center text-center"><small>권장 일일&nbsp;<b>2000</b><font color="gray">&nbsp;kcal</font></small></div>
            {% elif bad_kcal_dinner != 0 %}
            <div class="row mt-5 justify-content-center text-center">
                섭취&nbsp;<font color="red"><b>{{ bad_kcal_dinner }}</b></font><font color="gray">&nbsp;kcal</font>&nbsp;(부족/과잉)
            </div>
            <div class="row justify-content-center text-center"><small>권장 일일&nbsp;<b>2000</b><font color="gray">&nbsp;kcal</font></small></div>
            {% endif %}
            {% if good_food_dinner%}
            <div class="row mt-2 mb-1 justify-content-center">
                <div class="col d-flex justify-content-center">
                    <img class="w-25" src="{% static 'image/잘한 식단 아이.png' %}" alt="로고 이미지"/>
                </div>
            </div>
                {% for food in good_food_dinner%}
                <div class="row justify-content-center text-center">{{ food }}</div>
                {% endfor %}
            {% else %}
                <div class="row mt-2 justify-content-center">
                    <div class="col d-flex justify-content-center">
                        <img class="w-25" src="{% static 'image/못한 식단 아이.png' %}" alt="로고 이미지"/>
                    </div>
                </div>
                <div class="row mt-2 mb-2 justify-content-center text-center">아쉬운 식단이네요</div>
            {% endif %}
            {% if bad_food_dinner %}    
            <div class="row justify-content-center mt-1">
                <button class="btn sub_btn evening_nu_result_btn">부족/과잉 영양성분 보기</button>
            </div>
            {% else %}
            <div class="row justify-content-center mt-1">
                <button class="btn sub_btn" disabled>100점입니다!</button>
            </div>
            {% endif %}
        {% else %}
            <img class="w-100" src="{% static 'image/로고.png' %}" alt="로고 이미지"/>
        {% endif %}
        </div>
    </div>
</div>
<!-- 모달 -->
<div class="modal fade" id="morning_modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <b>아침 식단 업로드</b>
                <button type="button" class="close" data-dismiss="modal">
                    <span>x</span>
                </button>
            </div>
            <form id="morning_form" class="modal-body text-center" method="post" enctype="multipart/form-data">
                <img id="morning_previewImg" src="{% static 'image/식판.png' %}" alt="이미지가 존재하지 않습니다."/>
                <input type="file" id="morning_fileBtn" accept=".jpg, .png"/>
            </form>
            <div class="modal-footer justify-content-center">
                <button class="btn sub_btn" data-dismiss="modal">취소</button>
                <button class="btn main_btn" id="morning_upload">&nbsp;&nbsp;&nbsp;업로드&nbsp;&nbsp;&nbsp;</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="lunch_modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <b>점심 식단 업로드</b>
                <button type="button" class="close" data-dismiss="modal">
                    <span>x</span>
                </button>
            </div>
            <form id="lunch_form"  class="modal-body text-center">
                <img id="lunch_previewImg" src="{% static 'image/식판.png' %}" alt="이미지가 존재하지 않습니다."/>
                <input type="file" id="lunch_fileBtn" accept=".jpg, .png"/>
            </form>
            <div class="modal-footer justify-content-center">
                <button class="btn sub_btn" data-dismiss="modal">취소</button>
                <button class="btn main_btn" id="lunch_upload">&nbsp;&nbsp;&nbsp;업로드&nbsp;&nbsp;&nbsp;</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="evening_modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <b>저녁 식단 업로드</b>
                <button type="button" class="close" data-dismiss="modal">
                    <span>x</span>
                </button>
            </div>
            <form id="evening_form"  class="modal-body text-center">
                <img id="evening_previewImg" src="{% static 'image/식판.png' %}" alt="이미지가 존재하지 않습니다."/>
                <input type="file" id="evening_fileBtn" accept=".jpg, .png"/>
            </form>
            <div class="modal-footer justify-content-center">
                <button class="btn sub_btn" data-dismiss="modal">취소</button>
                <button class="btn main_btn" id="evening_upload">&nbsp;&nbsp;&nbsp;업로드&nbsp;&nbsp;&nbsp;</button>
            </div>
        </div>
    </div>
</div>
<!-- 음식 검색 모달 -->
<div class="modal fade" id="food_search" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <b>음식 검색</b>
                <button type="button" class="close" data-dismiss="modal">
                    <span>x</span>
                </button>
            </div>
            <div class="modal-body text-center">
                <div class="row">
                    <div class="col d-flex justify-content-end">
                        <input type="text" class="text-center w-50 ml-3 food_input" placeholder="한 글자 이상을 입력하세요."/>
                        <button class="btn search_food"><i class="fa-solid fa-magnifying-glass"></i></button>
                    </div>
                </div>
                <div class="row mt-3 mb-3 search_result" style="overflow-y: auto;">
                    <div class="row mt-2 mb-3 ml-5 picked_food_list"></div>
                    <table class="w-100 food_table"></table>
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                <button class="btn sub_btn" data-dismiss="modal">취소</button>
                <button class="btn main_btn" id="add_Btn">&nbsp;&nbsp;&nbsp;추가&nbsp;&nbsp;&nbsp;</button>
            </div>
        </div>
    </div>
</div>
<!-- 이미지 삭제 모달 -->
<div class="modal fade" id="del_modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <b>식단 이미지 삭제</b>
                <button type="button" class="close" data-dismiss="modal">
                    <span>x</span>
                </button>
            </div>
            <div class="modal-body text-center">
                <b><font color="red">정말 삭제하시겠습니까 ?</font></b>
            </div>
            <div class="modal-footer justify-content-center">
                <button class="btn sub_btn" data-dismiss="modal">취소</button>
                <button class="btn main_btn" id="delete_Btn">&nbsp;&nbsp;&nbsp;삭제&nbsp;&nbsp;&nbsp;</button>
            </div>
        </div>
    </div>
</div>
<!-- 아침 식단 부족/과잉 영양성분 모달 -->
<div class="modal fade" id="morning_nu_modal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <b>부족/과잉 영양성분</b>
                <button type="button" class="close" data-dismiss="modal">
                    <span>x</span>
                </button>
            </div>
            <div class="modal-body text-center nu_body">
                {% if good_kcal_breakfast != 0 %}
                <div class="row mt-2 justify-content-center text-center">
                    섭취&nbsp;<font color="blue"><b>{{ good_kcal_breakfast }}</b></font><font color="gray">&nbsp;kcal</font>&nbsp;(충분)
                </div>
                <div class="row justify-content-center text-center"><small>권장 일일&nbsp;<b>2000</b><font color="gray">&nbsp;kcal</font></small></div>
                {% elif bad_kcal_breakfast != 0 %}
                <div class="row mt-2 justify-content-center text-center">
                    섭취&nbsp;<font color="red"><b>{{ bad_kcal_breakfast }}</b></font><font color="gray">&nbsp;kcal</font>&nbsp;(부족/과잉)
                </div>
                <div class="row justify-content-center text-center"><small>권장 일일&nbsp;<b>2000</b><font color="gray">&nbsp;kcal</font></small></div>
                {% endif %}
                <div class="row mt-2 mb-1 justify-content-center">
                    <div class="col d-flex justify-content-center">
                        <img class="w-25" src="{% static 'image/못한 식단 아이.png' %}" alt="로고 이미지"/>
                    </div>
                </div>
                {% if bad_food_breakfast %}
                    {% for food in bad_food_breakfast %}
                    <div class="row justify-content-center text-center">{{ food }}</div>
                    {% endfor %}
                {% else %}
                    <div class="row justify-content-center text-center">^^</div>
                {% endif %} 
            </div>
            <div class="modal-footer justify-content-center">
                <button class="btn main_btn" data-dismiss="modal">확인</button>
            </div>
        </div>
    </div>
</div>
<!-- 점심 식단 부족/과잉 영양성분 모달 -->
<div class="modal fade" id="lunch_nu_modal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <b>부족/과잉 영양성분</b>
                <button type="button" class="close" data-dismiss="modal">
                    <span>x</span>
                </button>
            </div>
            <div class="modal-body text-center nu_body">
                {% if good_kcal_lunch != 0 %}
                <div class="row mt-2 justify-content-center text-center">
                    섭취&nbsp;<font color="blue"><b>{{ good_kcal_lunch }}</b></font><font color="gray">&nbsp;kcal</font>&nbsp;(충분)
                </div>
                <div class="row justify-content-center text-center"><small>권장 일일&nbsp;<b>2000</b><font color="gray">&nbsp;kcal</font></small></div>
                {% elif bad_kcal_lunch != 0 %}
                <div class="row mt-2 justify-content-center text-center">
                    섭취&nbsp;<font color="red"><b>{{ bad_kcal_lunch }}</b></font><font color="gray">&nbsp;kcal</font>&nbsp;(부족/과잉)
                </div>
                <div class="row justify-content-center text-center"><small>권장 일일&nbsp;<b>2000</b><font color="gray">&nbsp;kcal</font></small></div>
                {% endif %}
                <div class="row mt-2 mb-1 justify-content-center">
                    <div class="col d-flex justify-content-center">
                        <img class="w-25" src="{% static 'image/못한 식단 아이.png' %}" alt="로고 이미지"/>
                    </div>
                </div>
                {% if bad_food_lunch %}
                    {% for food in bad_food_lunch %}
                    <div class="row justify-content-center text-center">{{ food }}</div>
                    {% endfor %}
                {% else %}
                    <div class="row justify-content-center text-center">^^</div>
                {% endif %} 
            </div>
            <div class="modal-footer justify-content-center">
                <button class="btn main_btn" data-dismiss="modal">확인</button>
            </div>
        </div>
    </div>
</div>
<!-- 저녁 식단 부족/과잉 영양성분 모달 -->
<div class="modal fade" id="evening_nu_modal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <b>부족/과잉 영양성분</b>
                <button type="button" class="close" data-dismiss="modal">
                    <span>x</span>
                </button>
            </div>
            <div class="modal-body text-center nu_body">
                {% if good_kcal_dinner != 0 %}
                <div class="row mt-2 justify-content-center text-center">
                    섭취&nbsp;<font color="blue"><b>{{ good_kcal_dinner }}</b></font><font color="gray">&nbsp;kcal</font>&nbsp;(충분)
                </div>
                <div class="row justify-content-center text-center"><small>권장 일일&nbsp;<b>2000</b><font color="gray">&nbsp;kcal</font></small></div>
                {% elif bad_kcal_dinner != 0 %}
                <div class="row mt-2 justify-content-center text-center">
                    섭취&nbsp;<font color="red"><b>{{ bad_kcal_dinner }}</b></font><font color="gray">&nbsp;kcal</font>&nbsp;(부족/과잉)
                </div>
                <div class="row justify-content-center text-center"><small>권장 일일&nbsp;<b>2000</b><font color="gray">&nbsp;kcal</font></small></div>
                {% endif %}
                <div class="row mt-2 mb-1 justify-content-center">
                    <div class="col d-flex justify-content-center">
                        <img class="w-25" src="{% static 'image/못한 식단 아이.png' %}" alt="로고 이미지"/>
                    </div>
                </div>
                {% if bad_food_dinner %}
                    {% for food in bad_food_dinner %}
                    <div class="row justify-content-center text-center">{{ food }}</div>
                    {% endfor %}
                {% else %}
                    <div class="row justify-content-center text-center">^^</div>
                {% endif %} 
            </div>
            <div class="modal-footer justify-content-center">
                <button class="btn main_btn" data-dismiss="modal">확인</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block style %}
<style>
.container {
  font-family : 'Cafe24Dongdong'
}

#datepicker, input[name=food], select {
    border: #ff7449 1px solid;
    border-radius: 5px;
}

.kid_pofile {
    border: #ff7449 2px solid;
    border-radius: 20px;
}

#profile {
    width: 14rem;
    height: 13rem;
    border-radius: 25%;
    object-fit: cover;
}

#myChart {
    width: 35vw;
}

#morning_previewImg, #lunch_previewImg, #evening_previewImg {
    margin: 1rem;
    width: 18rem;
    height: 15rem;
    border: #ff7449 1px solid;
    border-radius: 20px;
}

.description {
    color: #808080;
}

.frame {
    height: 20rem;
    border: #ff7449 2px solid;
    border-radius: 20px;
}

.img {
    width: 75%;
    height: 15rem;
    border-radius: 20px;
}

.picked_food_list {
    height: 1rem;
}

.picked_food {
    border: #ff7449 1px solid;
    border-radius: 5%;
    background-color: #fcc5ae;
}

/* 모달 */
.modal-content {
    background-color: #ffede5;
}

.modal-header {
    border-bottom: #ff7449 1px solid;
}

.modal-footer {
    border-top: #ff7449 1px solid;
}

.search_result {
    height: 20rem;
    border-top: #ff7449 1px solid;
}

.food_input, .search_food {
    border: #ff7449 1px solid;
    border-radius: 5px;
}

</style>
{% endblock %}

{% block script %}

<script>
function modal_show(meal) {
    let meal_time

    if (meal == 'morning') meal_time = '아침'
    else if (meal == 'lunch') meal_time = '점심'
    else meal_time = '저녁'
    
    if ($('#' + meal).attr('src') != "{% static 'image/식판.png' %}") {
        $('#' + meal + '_modal img').attr('src', $('#' + meal).attr('src'))
    } else {
        $('#' + meal + '_modal img').attr('src', "{% static 'image/식판.png' %}")
    }

    $('#' + meal + '_fileBtn').val('')
    $('#' + meal + '_modal').modal('show')
}

function meal_upload(meal) {
    if (!$('#' + meal + '_fileBtn').val())
            $('#' + meal + '_mod').attr('disabled', 'disabled')

    $('#' + meal + '_fileBtn').change(function() {
        if(this.files[0]) {
            let reader = new FileReader()
            reader.readAsDataURL(this.files[0])
    
            reader.addEventListener('load', function() {
                $('#' + meal + '_previewImg').attr('src', reader.result)
                readerResult = reader.result
            }, false)
        }
        $('#' + meal + '_upload').removeAttr('disabled')
    })

    $('#' + meal + '_upload').click(function() {
        meal_img = $('#' + meal + '_previewImg').attr('src')
        $('#' + meal).attr('src', meal_img)

        let form = $('#' + meal + '_form')[0]
        let formData = new FormData(form)

        formData.append('meal_img', $('#' + meal + '_fileBtn')[0].files[0])  // 식단 이미지 사진

        $.ajax({
            url: 'upload',
            method: 'post',
            enctype: 'multipart/form-data',
            data: formData,
            contentType: false,
            processData: false,
        }).done(function(results) {
            results = results.replaceAll(',', '')
            results = results.split(' ')
            results_length = results.pop()
            if (results) {
                $.each(results, function(idx, food) {
                    add_food_place = '#' + meal + '_food_form .add_food'
                    $(add_food_place).before(
                        '<div class="row ml-1 mr-1 mt-3 mb-3">' +
                            '<input class="col w-100 mr-1" disabled value=' + food + ' name="food"/>' +
                            '<select name="portions">' +
                                '<option value="1인분">1인분</option>' +
                                '<option value="0.5인분">0.5인분</option>' +
                                '<option value="1.5인분">1.5인분</option>' +
                            '</select>' +
                            '<button class="btn main_btn ml-1 del_food_btn" id="del_' + meal + food + '_btn">삭제</button>' +
                        '</div>'
                    )
                })
            }
        })
        $('.' + meal + '_upload').attr('disabled', 'disabled')
        $('#' + meal + '_modal').modal('hide')
        $('.' + meal + '_del_btn').removeAttr('disabled')
    })
}

function del_meal_diet(meal) {
    let regdate = $('#datepicker').val()
    let meal_time

    if (meal == 'morning') meal_time = '아침'
    else if (meal == 'lunch') meal_time = '점심'
    else meal_time = '저녁'

    $('#del_modal').modal('show')
    $('#delete_Btn').click(function() {
        $.ajax({
            url: 'del_meal_diet',
            method: 'delete',
            data: JSON.stringify({
                regdate: regdate,
                meal_time: meal_time,
                kid_id: sessionStorage.getItem('kid_id')
            }),
            contentType: 'application/json'
        }).done(function(result) {
            $('#' + meal).attr('src', "{% static 'image/식판.png' %}")
            $('.' + meal + '_del_btn').attr('disabled', 'disabled')
            $('.' + meal + '_upload').removeAttr('disabled')
            $('#' + meal +'_food_form div').remove()
            $('#' + meal +'_frame .add_food').removeAttr('disabled')
            $('#' + meal +'_frame .result_btn').removeAttr('disabled')
            $('#del_modal').modal('hide')
            window.location.reload()
        })
    })
}

$(document).ready(function() {
    console.log(sessionStorage.getItem('kid_id'))
    // 데이트피커
    //input을 datepicker로 선언
    $("#datepicker").datepicker({
        dateFormat: 'yy-mm-dd', //달력 날짜 형태
        showOtherMonths: true, //빈 공간에 현재월의 앞뒤월의 날짜를 표시
        showMonthAfterYear:true, // 월- 년 순서가아닌 년도 - 월 순서
        changeYear: true, //option값 년 선택 가능
        changeMonth: true, //option값  월 선택 가능                           
        yearSuffix: "년", //달력의 년도 부분 뒤 텍스트
        monthNamesShort: ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'], //달력의 월 부분 텍스트
        monthNames: ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'], //달력의 월 부분 Tooltip
        dayNamesMin: ['일','월','화','수','목','금','토'], //달력의 요일 텍스트
        dayNames: ['일요일','월요일','화요일','수요일','목요일','금요일','토요일'], //달력의 요일 Tooltip
        minDate: "-5Y", //최소 선택일자(-1D:하루전, -1M:한달전, -1Y:일년전)
        maxDate: "+0d" //최대 선택일자(+1D:하루후, -1M:한달후, -1Y:일년후)  
    })

    //차트

    let canvas = document.getElementById('myChart')
    let ctx = canvas.getContext('2d')
    let labels = ['칼로리','탄수화물','단백질','지방','나트륨','칼슘','철분']
    let intake = {{ intake|safe }}

    console.log(intake)

    let myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                axis: 'y',
                label: '아침',
				data: intake.breakfast_per,
				backgroundColor: [
                    'rgba(255, 0, 0, 0.5)'
                ],
				hoverBackgroundColor: [
                    'rgb(255, 0, 0)'
                ]
			},{
                axis: 'y',
                label: '점심',
				data: intake.lunch_per,
				backgroundColor: [
                    'rgba(255, 255, 0, 0.5)'
                ],
				hoverBackgroundColor: [
                    'rgb(255, 255, 0)'
                ]
			},{
                axis: 'y',
                label: '저녁',
				data: intake.dinner_per,
				backgroundColor: [
                    'rgba(0, 255, 0, 0.5)'
                ],
				hoverBackgroundColor: [
                    'rgb(0, 255, 0)'
                ]
			}]
        },

        options: {
            responsive: false,
            type: 'bar',
            indexAxis: 'y',
            plugins: {
                title: {
                    display: true,
                    position: 'bottom',
                    text: '일일 권장섭취량 (%)'
                },
            },
            scales: {
                x: {
                    stacked: true,
                    //max:100,
                    ticks: {
                        callback: function(value, index, ticks) {
                            return value+'%'
                        }
                    },
                    grid: {
                        lineWidth: 1
                    },
                },
                y: {
                    stacked: true,                                      
                    ticks: {
                        display: true, //this will remove only the label
                    },
                    grid: {
                        lineWidth: 1
                    }
                },
            }
        }

    })

    
    $('.morning_upload').click(function() {
        modal_show('morning')        
        meal_upload('morning')
    })

    $('.lunch_upload').click(function() {
        modal_show('lunch')
        meal_upload('lunch')
    })

    $('.evening_upload').click(function() {
        modal_show('evening')
        meal_upload('evening')
    })

    $('.morning_del_btn').click(function() {
        del_meal_diet('morning')
    })

    $('.lunch_del_btn').click(function() {
        del_meal_diet('lunch')
    })

    $('.evening_del_btn').click(function() {
        del_meal_diet('evening')
    })

    // 검색 모달 띄우고 결과값 들어가게
    $('.add_food').click(function() {
        
        // 들어갈 폼 - 전역변수 선언
        window.parent_food_form = $(this).parent().attr('id')
        window.food_list = []  // 전역변수 선언

        $('.food_table').empty()
        $('.picked_food_list').empty()
        $.ajax({
            url: 'food_list',
            method: 'post',
        }).done(function(foods) {
            if (foods) {
                foods = foods.split(' ')
                $.each(foods, function(idx, food) {
                    if (food) {
                        $('.food_table').append(`<div class="mb-3 ml-5" style="text-align: start;"><input type="checkbox" name="food" value="${food}" id="${food}"/> ${food}</div>`)
                    }
                })
            }
        })
        $('.food_input').val('')
        $('#food_search').modal('show')
    })

    // 실시간 검색
    let old_val
    $(".food_input").on("propertychange change keyup paste input", function(){
        let current_val = $(this).val()
        if (current_val == old_val) {
            return
        }
        old_val = current_val
        $.ajax({
            url: 'search_food_list',
            method: 'post',
            data: JSON.stringify({
                search_data: $('.food_input').val()
            }),
            contentType: 'application/json'
        }).done(function(foods) {
            $('.food_table').empty()
            if (foods) {
                foods = foods.split(' ')
                $.each(foods, function(idx, food) {
                    if (food) {
                        $('.food_table').append(`<div class="mb-3 ml-5" style="text-align: start;"><input type="checkbox" name="food" value="${food}" id="${food}"/> ${food}</div>`)
                    }
                })
            } else if (!foods) {
                $('.food_table').append('<font class="d-flex justify-content-center" color="red">『' + $('.food_input').val() + '』에 대한 검색 결과가 존재하지 않습니다.</font>')
            }
        })
    })

    $('.search_food').click(function() {
        if (!($('.food_input').val())) {
            $('.food_table').empty()
            $('.food_table').append('<font class="d-flex justify-content-center" color="red">한 글자 이상 검색해주세요.</font>')
        }
    })
    
    // 검색창에서 음식 선택
    $(document).on('click', 'input:checkbox', function() {
        food_id = $(this).attr('id')
        check_id = '#' + food_id
        if($(check_id).is(':checked')) {
            $('.picked_food_list').append(`<button class="mr-1 p-1 picked_food" id="${food_id}"><small>${food_id} x</small></button>`)
            window.food_list.push(food_id)
        }
    })

    // 검색창에서 선택된 음식 삭제 & 체크박스 해제
    $(document).on('click', '.picked_food', function() {
        food_id = $(this).attr('id')
        picked_id = '#' + food_id
        $('input:checkbox[id="' + food_id +'"]').prop('checked', false)
        $('button' + picked_id).remove()

        // 전역변수에서도 해당 음식 삭제
        for(let i = 0; i < window.food_list.length; i++) {
            if (window.food_list[i] === food_id) {
                window.food_list.splice(i, 1)
                i--
            }
        }
    })

    // 음식 검색 후 음식 추가
    $('#add_Btn').click(function() {
        add_food_place = '#' + window.parent_food_form + ' .add_food'
        cnt = $('.picked_food_list').children().length

        for (let i = 0; i < cnt; i++) {
            $(add_food_place).before(
                '<div class="row ml-1 mr-1 mt-3 mb-3">' +
                    '<input class="col w-100 mr-1" disabled value=' + window.food_list[i] + ' name="food"/>' +
                    '<select name="portions">' +
                        '<option value="1인분">1인분</option>' +
                        '<option value="0.5인분">0.5인분</option>' +
                        '<option value="1.5인분">1.5인분</option>' +
                    '</select>' +
                    '<button class="btn main_btn ml-1 del_food_btn" id="del_' + window.parent_food_form + window.food_list[i] + '_btn">삭제</button>' +
                '</div>'
            )
        }
        $('#food_search').modal('hide')
    })
    // 음식 삭제
    $(document).on('click', '.del_food_btn', function() {
        btn_id = '#' + $(this).attr('id')
        $(btn_id).parent().remove()
    })

    // 식단 결과 확인 - meal, diet 객체 생성
    $('.result_btn').click(function() {
        food_form = '#' + $(this).parent().parent().attr('id') + ' div:nth-child(2)'
        console.log(food_form)
        food_row = '#' + $(food_form).attr('id') + ' input'
        food_row_portions = '#' + $(food_form).attr('id') + ' select option:selected'
        food_result = []
        portions = []

        if ($(food_row).val()) {
            for(let i = 0; i < $(food_row).length; i++) {
                food_result.push($(food_row).eq(i).val())
                portions.push($(food_row_portions).eq(i).val())
            }
            let meal = $(this).parent().parent().attr('id').replace('_frame', '')
            let form = $('#' + meal + '_form')[0]
            let formData = new FormData(form)
            formData.append('meal_img', $('#' + meal + '_fileBtn')[0].files[0])
            formData.append('date', $('#datepicker').val())
            formData.append('frame', $(food_form).attr('id'))
            formData.append('food_result', food_result)
            formData.append('portions', portions)
            formData.append('kid_id', sessionStorage.getItem('kid_id'))

            $.ajax({
                url: 'meal_diet',
                method: 'post',
                enctype: 'multipart/form-data',
                data: formData,
                contentType: false,
                processData: false,
            }).done(function(results) {
                window.location.reload()
            })
            $(this).attr('disabled', 'disabled')
            $('.' + meal + '_upload').attr('disabled', 'disabled')
            $('.' + meal + '_del_btn').removeAttr('disabled')
            $('#' + $(food_form).attr('id') + ' .del_food_btn').attr('disabled', 'disabled')
            $('#' + $(food_form).attr('id') + ' select').attr('disabled', 'disabled')
            $('#' + $(food_form).attr('id') + ' .add_food').attr('disabled', 'disabled')
        }
    })

    // 부족/과잉 영양성분 보기
    $('.morning_nu_result_btn').click(function() {
        $('#morning_nu_modal').modal('show')
    })
    $('.lunch_nu_result_btn').click(function() {
        $('#lunch_nu_modal').modal('show')
    })
    $('.evening_nu_result_btn').click(function() {
        $('#evening_nu_modal').modal('show')
    })
})
</script>

{% endblock %}